name: inverse
layout: true
class: center, middle
---
# Автоматизация тестовой инфраструктуры
.footnote[Антон Галицын, [2GIS](2gis.ru)]

???
Всем привет, меня зовут Антон, и сегодня мы поговорим об автоматизации тестовой инфраструктуры в 2ГИСе

---

layout: false

## Зачем меня слушать?

- Разработчик в отделе Infrastrusture & Operations

- Работал в команде OpenStack над интеграцией

- Занимаюсь автоматизацией деплоймента проектов 2ГИСа

???
Я разработчик в отделе Infrastrusture & Operations, прошлый год целиком посвятил себя проекту OpenStack, разработкой систем деплоймента, тулинга для тестирования как самого OpenStack, так и проектов web-отдела 2ГИС. Сейчас работаю над автоматизацией деплоймента рассчетных бекендов.

---

layout: false

## 2ГИС

- Web, Mobile, Desktop

- 35 команд

???
2ГИС - это городской справочник и карты. 2гис выпускается в разных версиях, это web, мобильная (android, ios, windows phone) и десктопная для windows. Все эти версии, а так же общие библиотеки и сервисы разрабатывает много команд, всего 35.

---

layout: false

## Команды

- Разные языки, много интеграций

- Автоматическое тестирование

- Нужны достоверные результаты

???
Каждая команда, в зависимости от сферы, пишет на своем языке, использует какие-то инструменты. Но есть то, что их объединяет - это интеграции. Поэтому каждая команда использует автоматическое тестирование и хочет получать достоверные результаты в своем продукте, и так же хочет этого у соседних к ней.

---

template: inverse

## Достоверные автотесты

???
что такое достоверные автотесты, существуют ли они?
---

## Достоверные автотесты

- Результат автотестов повторяем

- Результат соответсвует реальной картине на бою

???
Результаты автотестов должен быть повторяем. Если они то падают, то нет, доверия к тестам нет и их просто скипают.

Они реально отражают ситуацию на бою. Если в тестовой среде ничего не падает, а на бою падает, то в следующий раз тестировать будут прямо на бою. Зачем их гонять и ждать, они же все равно ничего не покажут.

---

## Проблемы

- Большое количество конфигураций

- Неоднородные окружения

- Автотесты оставляют артефакты

???
С автотестами я думаю у всех здесь возникали проблемы разного характера, я бы выделил 3 ключевых проблемы для 2ГИСа

Первая - большое количество конфигураций
Вот вам реальный кейс - надо прогнать определенные тесты для проверки фичи продукта A, собранного с ветки B и развернутого в конфигурации C.

Вторая - неоднородное окружение
У разработчика своя машина, он настраивает проект в vagrant, у тестировщика своя виртуальная машина на тестовых серверах. Все это скрипты, конфиги, ручные действия. Вы скажете, а как же configuration management улитилы, типо ansible. Да, они есть, но не у всех они могут сдеплоить "не бой". А в 2гис сервисы большие, их много и разворачивать всегда копию боя невозможно.

Тесты портят и без того неоднородное окружение
Оставленные в кеше приложения тестовые данные, подвисшие процессы, измененная база - примеры артефактов после тестов. Приложение уже может выдавать другой результат при тех же тестах

---

## Требования

- Список конфигураций

- Автоматический деплоймент

- Легко развертываемое окружение

- ~~Автотесты чистят мусор~~

???

Проблемы начали анализировать и пришли к выводам

Нужны списки конфигураций для каждого проекта. Конфигурация "все над одной машине", конфигурация распределенная, конфигурация для нагрузочного тестирования и тд

Каждый проект должен уметь автоматический деплоиться во все нужные конфигурации общеизвестными способами. Ansible, chef

Окружение должно быть легко развертываемым, нельзя по полдня ждать виртуалок

Рефакторинг автотестов быстро отмели в сторону, тк их бывает по 60 000 на проект, и лучше концентрироваться на сценариях и параллельном исполнении тестов

---

## Идеальное окружение

Полная копия боевой конфигурации и базы за 1 наносекунду.

???
Идеал - это копия боя, которая разворачивается за 1 наносекунду с полной боевой базы. Увы, в 2гис сервисы большие, их много и такое физически невозможно. Нужно инженерное решение.

---

## Реальное окружение

Конец 2013 года - Proxmox Virtual Environment

- Создание виртуалок по тикету руками

- Нет разделения по проектам

- API малофункционален, плагины платные

???

На конец 2013 года команды разработки и администрирования работали через тикеты, создать виртуалки, DNS, сеть, миграция - все руками. Proxmox - это система система виртуализации с гипервизорами KVM и OpenVZ, которая может объедять узлы в одноранговый кластер. Управление через web GUI.

* Создание виртуалок по тикету
  Понятно - медленно, никто лишний раз обращаться не будет. У команд были либо уже созданные виртуалки, на которые сдеплоили 100500 раз. Деплоймент проекта на чистую машину часто не работает.

* Ничьи машинки
    Перестали пользоваться - ничего не сказали админам. В результате постоянно надо устраивать контрольные чистки с раздачей пинков.

Автоматизация была сильно ограничина в инструментах для инфраструктуры, по причине отсутвия нормального API и контроля доступа.

---

template: inverse

## Viva, OpenStack!

???
Было проведено исследование и выбрали нового короля, да здравствует OpenStack!

---

Здесь: что такое OpenStack

---

Проблема - решение

.left-column[
  ## Почему?
]
.right-column[

- Можно подключить много разного железа и эффективно утилизировать

- Есть ACL и разделение по проектам, у каждого свой pool ресурсов

- OpenStack - конструктор, берем только нужное

- Можно добавить свои компоненты

- Все сервисы работают по API, можно писать свои скрипты и middleware

- Активное сообщество и бурное развитие проекта

]

???
Про OpenStack много всего написано в интернете, и хорошего и плохого, мы его выбрали потому что *список*

---

.left-column[
  ## Сценарии
]
.right-column[

- Рабочее окружение

- Демо стенды

- Интеграционные стенды

- Тестовые стенды

- Командная инфраструктура

- Внутренние сервисы

- Эксперименты

]

???
В итоге внутри компании мы используем опенстек для следующих нужд

* Рабочее окружение
  Стенды, которые не влазиют или не удобно деплоить в vagrant

* Демо стенды
  Для сбора фидбека с продактов или коллег

* Интеграционные стенды
  Для предоставления последней стабильной версии API

* Тестовые стенды
  Как раз для прогона автотестов

* Командная инфраструктура
  Дженкинсы, тимсити, гитлаб раннеры

* Внутренние сервисы
  Внутренние продукты, об этом позже

* Эксперименты
  Например стенд проекта, который переехал с posgresql 9.3 на 9.4
---


### Решение проблем окружения

Повторяемость окружения:

- Разные конфигурации для проектов

- Деплой "на чистую"

Технически:

- Heat шаблоны в общем репозитории

- Свои heat ресурсы

- Утилиты для работы с heat API

---

template: inverse

## Развитие автоматизации

---

### Развитие автоматизации

[github.com/2gis/badger](https://github.com/2gis/badger) - Cистема мониторинга качества продуктов

[github.com/2gis/vmmaster](https://github.com/2gis/vmmaster) - динамический selenium grid

Continuous integration - много Jenkins'ов с разными slave, Gitlab CI runners, Docker фермы

Нагрузочное тестирование

???
Про проект Badger можете посмотерь презентацию моей коллеги Ирины Шрейдер с SQADAYS http://sqadays.com/ru/talk/37798

Про проект Vmmaster можно посмотреть презентацию моего коллеги Коли Устинова с devday https://devday.ru/report/155

Continuous integration теперь это просто, развернул машинку, накатил ansible playbook, готово

Нагрузочное тестирование тоже получило свое, они разворачивают большие распределенные сеты с помощью heat в отдельных compute нода

template: inverse

## Infrastrusture & Operations

???
Поэтому у нас есть отдел, готовый решить эти проблемы
---
.left-column[
  ## IO
]
.right-column[
Отдел в 2ГИС, занимающийся:

- Интеграцией OpenStack

- Платформой для web и backend сервисов

- Автоматизацией HA баз данных

- Системой логирования и мониторинга

- Разработкой тулов для разработчиков

- Эксплуатацией боевой инфраструктуры

.footnote[.red[*] Мы используем python, ansible, docker, golang]

]

???
Мы занимаемся разными инфраструктурными проектами, такими как *список*, в частности сегодня говорить будем про OpenStack, в котором я работал в прошлом году.
---

template: inverse

## Нераскрытые темы

???
Так как тема обширная, подитожим и поймем что я не рассказал
---
### Нераскрытые темы

- OpenStack в production окружении

- Как мы деплоим OpenStack

- Как мы тестируем OpenStack в OpenStack'e

- Опыт разработки heat ресурсов

- Как мы закрываем *вот-такой то* сценарий

- А как жить с соседями, которые кошмарят compute ноды

???
Не рассказал я многое, например *список*

можете мне задать эти вопросы или любые другие сейчас или после доклада

---
name: last-page
template: inverse

## Спасибо!

Антон Галицын

a.galitsyn@2gis.ru
[github.com/agalitsyn](http://github.com/agalitsyn)

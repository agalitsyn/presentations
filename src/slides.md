name: inverse
layout: true
class: center, middle, inverse
---
# Автоматизация тестовой инфраструктуры
<!-- [ri-mahrk] -->
.footnote[Антон Галицын, [2GIS](2gis.ru)]

???
Всем привет, меня зовут Антон, и сегодня мы поговорим об автоматизации тестовой инфраструктуры в 2ГИСе

---
## План
---
layout: false
.left-column[
  ## План
  ### Часть 1
]
.right-column[

- Что такое достоверные автотесты

- Об отделе Infrastrusture & Automation

- Какой была инфраструктура в конце 2013

]

???
Доклад состоит из 3х частей, первая - поговорим о том, что такое достоверные автотесты, существуют ил они? Потом об отделе Infrastrusture & Automation, в котором я работаю, и чем мы занимаемся. Он появился недавно, поэтому стоит отметить какой была инфраструктура в конце 2013, на момент создания тогда еще команды.

---
layout: false
.left-column[
  ## План
  ### Часть 1
  ### Часть 2
]
.right-column[

- Что такое достоверные автотесты

- Об отделе Infrastrusture & Automation

- Какой была инфраструктура в конце 2013

- Какие проблемы и потребности были у команд

- Внедрение OpenStack для IaaS

- Сценарии использования OpenStack
]

???
Во второй части мы обсудим какие проблемы в области инфраструктуры стояли перед командами. Почему мы решили, что будем внедрять OpenStack, и какие сценарии его использования у нас есть.

---
layout: false
.left-column[
  ## План
  ### Часть 1
  ### Часть 2
  ### Часть 3
]
.right-column[

- Что такое достоверные автотесты

- Об отделе Infrastrusture & Automation

- Какой была инфраструктура в конце 2013

- Какие проблемы и потребности были у команд

- Внедрение OpenStack для IaaS

- Сценарии использования OpenStack

- Развитие автоматизации и новые внутренние продукты на базе OpenStack
]

???
Напоследок я расскажу, как автоматизация получила дополнительный толчок в развитии и начали появляться новые внутренние продукты.

---
template: inverse

## Достоверные автотесты
---

### Достоверные автотесты

- Результат тестов повторяем

- Результат соответсвует реальной картине на бою

???
Достоверные автотесты - а бывают ли они? Я бы выделил 2 главных черты - результаты повторяемы, и они реально отражают ситуацию на бою.
Если они то падают, то нет, доверия к тестам нет и их просто скипают. Если в тестовой среде ничего не падает, а на бою падает, то в следующий раз тестировать будут прямо на бою.

---

### Достоверные автотесты

- Результат тестов повторяем

- Результат соответсвует реальной картине на бою

#### Как добиться?

Нужно окружение

- Легко развертываемое

- Приближенное к бою

???
Допустим тесты есть. А где и на чем их гонять? Нужно окружение.

---

### Достоверные автотесты

- Результат тестов повторяем

- Результат соответсвует реальной картине на бою

#### Как добиться?

Нужно окружение

- Легко развертываемое

- Приближенное к бою

#### Идеал

Полная копия боя с базой за 1 наносекунду у вас на ноутбуке.

???
Идеал - это копия боя, которая разворачивается за 1 наносекунду с полной боевой базы. Увы, в 2гис сервисы большие, их много и такое физически невозможно. Нужно инженерное решение.

---
template: inverse

## Infrastrusture & Automation

???
Поэтому у нас есть отдел, готовый решить эти проблемы
---
.left-column[
  ## IO
]
.right-column[
Отдел в 2ГИС, занимающийся:

- Интеграцией OpenStack

- Платформой для web и backend сервисов

- Автоматизацией HA баз данных

- Системой логирования и мониторинга

- Разработкой тулов для разработчиков

- Эксплуатацией боевой инфраструктуры

.footnote[.red[*] Мы используем python, ansible, docker, golang]

]

???
Мы занимаемся разными инфраструктурными проектами, такими как *список*, в частности сегодня говорить будем про OpenStack, в котором я работал в прошлом году.

---
template: inverse

## Конец 2013
---

.left-column[
  ## Было
]
.right-column[

- У админов есть dev кластер на Proxmox

- У команд есть какие-то виртуалки и vagrant
]

---

.left-column[
  ## Было
]
.right-column[

- У админов есть dev кластер на Proxmox

- У команд есть какие-то виртуалки и vagrant

#### Проблемы процессов

- Создание виртуалок по тикету

- Есть ничьи машинки

- По ошибке удалил не свою машинку

- Малое вовлечение команды во владение ресурсами.
]
---

.left-column[
  ## Было
]
.right-column[

- У админов есть dev кластер на Proxmox

- У команд есть какие-то виртуалки и vagrant

#### Проблемы инфраструктуры

- Нет разделения по проектам

- Старые ядра Linux

- Конфликты IP адресов

- Рассинхронизация версий proxmox, баги
]

---

.left-column[
  ## Было
]
.right-column[

- У админов есть dev кластер на Proxmox

- У команд есть какие-то виртуалки и vagrant

#### Проблемы автоматизации

- Одноранговый кластер, не дать доступ командам, каша и бардак

- Плагины либо платные либо плохие

- Приходится строить свои поделки вокруг, тк развивать сам proxmox нет возможности

]
---

.left-column[
  ## Было
]
.right-column[

- У админов есть dev кластер на Proxmox

- У команд есть какие-то виртуалки и vagrant

#### Проблемы масштабирования

- Если надо сдеплоить новый большой проект - это займет админа на несколько дней

- Человеческий фактор, можно ошибиться не подозревая об этом, обнаружить ошибку уже в эксплуатации

- Админ должен анализировать место и сервисы, вручную указывать, на какую HW ноду положить новую виртуалку

- При выходе из строя железки  - не понятно как сделать такую же ноду

]

---
template: inverse

## Viva, OpenStack!

---

.left-column[
  ## Почему?
]
.right-column[

- Можно подключить много разного железа и эффективно утилизировать

- Конструктор, берем только нужное

- Можно добавить свои компоненты

- Все сервисы - API, можно писать скрипты

- Активное сообщество и бурное развитие

]

---

.left-column[
  ## Сценарии
]
.right-column[

- Рабочее окружение

- Демо стенды

- Интеграционные стенды

- Тестовые стенды

- Командная инфраструктура

- Внутренние сервисы

- Эксперименты

]

---

.left-column[
  ## Сервисы
]
.right-column[

- Dashboard (Horizon)

- Compute (Nova)

- Glance (VMI)

- Cinder (Volumes)

- Neutron (Network)

- Keystone (Auth)

- Designate (DNS)

- Heat (Orchestration)
]

---

### Решение проблем окружения

Повторяемость окружения:

- Разные конфигурации для проектов

- Деплой "на чистую"

Технически:

- Heat шаблоны в общем репозитории

- Свои heat ресурсы (chef, ansible, dns)

- Утилиты для работы с heat API

---
template: inverse

## Развитие автоматизации

---

### Развитие автоматизации

Badger - система мониторинга качества продуктов

Vmmaster - динамический selenium grid

Нагрузочное тестирование

---
name: last-page
template: inverse

## Спасибо!

Антон Галицын

[github.com/agalitsyn](http://github.com/agalitsyn)

name: inverse
layout: true
class: center, middle, inverse
---
# Автоматизация тестовой инфраструктуры
<!-- [ri-mahrk] -->
.footnote[Антон Галицын, [2GIS](2gis.ru)]

???
Всем привет, меня зовут Антон, и сегодня мы поговорим об автоматизации тестовой инфраструктуры в 2ГИСе

---
## План
---
layout: false
.left-column[
  ## План
  ### Часть 1
]
.right-column[

- Что такое достоверные автотесты

- Об отделе Infrastrusture & Automation

- Какой была инфраструктура в конце 2013

]

???
Доклад состоит из 3х частей, первая - поговорим о том, что такое достоверные автотесты, существуют ил они? Потом об отделе Infrastrusture & Automation, в котором я работаю, и чем мы занимаемся. Он появился недавно, поэтому стоит отметить какой была инфраструктура в конце 2013, на момент создания тогда еще команды.

---
layout: false
.left-column[
  ## План
  ### Часть 1
  ### Часть 2
]
.right-column[

- Что такое достоверные автотесты

- Об отделе Infrastrusture & Automation

- Какой была инфраструктура в конце 2013

- Какие проблемы и потребности были у команд

- Внедрение OpenStack для IaaS

- Сценарии использования OpenStack
]

???
Во второй части мы обсудим какие проблемы в области инфраструктуры стояли перед командами. Почему мы решили, что будем внедрять OpenStack, и какие сценарии его использования у нас есть.

---
layout: false
.left-column[
  ## План
  ### Часть 1
  ### Часть 2
  ### Часть 3
]
.right-column[

- Что такое достоверные автотесты

- Об отделе Infrastrusture & Automation

- Какой была инфраструктура в конце 2013

- Какие проблемы и потребности были у команд

- Внедрение OpenStack для IaaS

- Сценарии использования OpenStack

- Развитие автоматизации и новые внутренние продукты на базе OpenStack
]

???
Напоследок я расскажу, как автоматизация получила дополнительный толчок в развитии и начали появляться новые внутренние продукты.

---
template: inverse

## Достоверные автотесты
---

### Достоверные автотесты

- Результат тестов повторяем

- Результат соответсвует реальной картине на бою

???
Достоверные автотесты - а бывают ли они? Я бы выделил 2 главных черты - результаты повторяемы, и они реально отражают ситуацию на бою.
Если они то падают, то нет, доверия к тестам нет и их просто скипают. Если в тестовой среде ничего не падает, а на бою падает, то в следующий раз тестировать будут прямо на бою.

---

### Достоверные автотесты

- Результат тестов повторяем

- Результат соответсвует реальной картине на бою

#### Как добиться?

Нужно окружение

- Легко развертываемое

- Приближенное к бою

???
Допустим тесты есть. А где и на чем их гонять? Нужно окружение.

---

### Достоверные автотесты

- Результат тестов повторяем

- Результат соответсвует реальной картине на бою

#### Как добиться?

Нужно окружение

- Легко развертываемое

- Приближенное к бою

#### Идеал

Полная копия боя с базой за 1 наносекунду у вас на ноутбуке.

???
Идеал - это копия боя, которая разворачивается за 1 наносекунду с полной боевой базы. Увы, в 2гис сервисы большие, их много и такое физически невозможно. Нужно инженерное решение.

---
template: inverse

## Infrastrusture & Automation

???
Поэтому у нас есть отдел, готовый решить эти проблемы
---
.left-column[
  ## IO
]
.right-column[
Отдел в 2ГИС, занимающийся:

- Интеграцией OpenStack

- Платформой для web и backend сервисов

- Автоматизацией HA баз данных

- Системой логирования и мониторинга

- Разработкой тулов для разработчиков

- Эксплуатацией боевой инфраструктуры

.footnote[.red[*] Мы используем python, ansible, docker, golang]

]

???
Мы занимаемся разными инфраструктурными проектами, такими как *список*, в частности сегодня говорить будем про OpenStack, в котором я работал в прошлом году.

---
template: inverse

## Конец 2013
---

.left-column[
  ## Было
]
.right-column[

- У админов есть dev кластер на Proxmox

- У команд есть какие-то виртуалки и vagrant
]

???

На конец 2013 года команды разработки и администрирования работали через тикеты, создать виртуалки, DNS, сеть, миграция - все руками. Proxmox - это система система виртуализации с гипервизорами KVM и OpenVZ, которая может объедять узлы в одноранговый кластер. Управление через web GUI.
А у команд были либо уже созданные виртуалки, на которые сдеплоили 100500 раз, либо локально vagrant.

---

.left-column[
  ## Было
]
.right-column[

- У админов есть dev кластер на Proxmox

- У команд есть какие-то виртуалки и vagrant

#### Проблемы процессов

- Создание виртуалок по тикету

- Есть ничьи машинки, малое вовлечение команды во владение ресурсами

- По ошибке админ удалил не ту машинку

- Деплоймент проекта на чистую машину часто не работает
]

???
Проблемы процессов были следующие:

* Создание виртуалок по тикету
  Понятно - медленно, никто лишний раз обращаться не будет

* Ничьи машинки
  Перестали пользоваться - ничего не сказали админам. В результате постоянно надо устраивать контрольные чистки с раздачей пинков.

* По ошибке удалил не то, а авто деплоймента нет, либо он не работает. В итоге день или больше команда переразворачивает проект.
---

.left-column[
  ## Было
]
.right-column[

- У админов есть dev кластер на Proxmox

- У команд есть какие-то виртуалки и vagrant

#### Проблемы инфраструктуры

- Одноранговый кластер, не дать доступ командам, нет разделения по проектам

- Старые ядра Linux

- Конфликты IP адресов

- Рассинхронизация версий proxmox на разных хостах, странные баги
]

???
Со стороны админов тоже фарш. Ручная работа, не пойми что где находится, и тупо технические баги, такие как *список*

---

.left-column[
  ## Было
]
.right-column[

- У админов есть dev кластер на Proxmox

- У команд есть какие-то виртуалки и vagrant

#### Проблемы автоматизации

- Плагины либо платные либо плохие

- Приходится строить свои поделки вокруг, тк развивать сам proxmox нет возможности

]

???
Автоматизация была сильно ограничина в инструментах для инфраструктуры, по причине отсутвия нормального API и контроля доступа.

---

.left-column[
  ## Было
]
.right-column[

- У админов есть dev кластер на Proxmox

- У команд есть какие-то виртуалки и vagrant

#### Проблемы масштабирования

- Если надо сдеплоить новый большой проект - это займет админа на несколько дней

- Человеческий фактор, можно ошибиться не подозревая об этом, обнаружить ошибку уже в эксплуатации

- Админ должен анализировать место и сервисы, вручную указывать, на какую HW ноду положить новую виртуалку

- При выходе из строя железки  - не понятно как сделать такую же ноду

]

???
Еще проблемы из разряда администрирования, такие как *список*

---
template: inverse

## Viva, OpenStack!

???
Было проведено исследование и выбрали нового короля, да здравствует OpenStack!

---

.left-column[
  ## Почему?
]
.right-column[

- Можно подключить много разного железа и эффективно утилизировать

- Есть ACL и разделение по проектам, у каждого свой pool ресурсов

- OpenStack - конструктор, берем только нужное

- Можно добавить свои компоненты

- Все сервисы работают по API, можно писать свои скрипты и middleware

- Активное сообщество и бурное развитие проекта

]

???
Про OpenStack много всего написано в интернете, и хорошего и плохого, мы его выбрали потому что *список*

---

.left-column[
  ## Сценарии
]
.right-column[

- Рабочее окружение

- Демо стенды

- Интеграционные стенды

- Тестовые стенды

- Командная инфраструктура

- Внутренние сервисы

- Эксперименты

]

???
В итоге внутри компании мы используем опенстек для следующих нужд

* Рабочее окружение
  Стенды, которые не влазиют или не удобно деплоить в vagrant

* Демо стенды
  Для сбора фидбека с продактов или коллег

* Интеграционные стенды
  Для предоставления последней стабильной версии API

* Тестовые стенды
  Как раз для прогона автотестов

* Командная инфраструктура
  Дженкинсы, тимсити, гитлаб раннеры

* Внутренние сервисы
  Внутренние продукты, об этом позже

* Эксперименты
  Например стенд проекта, который переехал с posgresql 9.3 на 9.4
---

.left-column[
  ## Сервисы
]
.right-column[

- Dashboard (Horizon)

- Compute (Nova)

- Glance (VMI)

- Cinder (Volumes)

- Neutron (Network)

- Keystone (Auth)

- Designate (DNS)

- Heat (Orchestration)
]

???
Мы используем следующие компоненты OpenStack

* Dashboard (Horizon)
  Для web UI

* Compute (Nova)
  Создание VM, планировщик

* Glance (VMI)
  Образа операционных систем

* Cinder (Volumes)
  Перманентное хранилище с бекендов в ceph

* Neutron (Network)
  Виртуальные сети для изоляции проектов

* Keystone (Auth)
  Авторизация и права доступа

* Designate (DNS)
  Доменные имена

* Heat (Orchestration)
  Оркестратор, групповые операции

---

### Решение проблем окружения

Повторяемость окружения:

- Разные конфигурации для проектов

- Деплой "на чистую"

Технически:

- Heat шаблоны в общем репозитории

- Свои heat ресурсы

- Утилиты для работы с heat API

---

template: inverse

## Развитие автоматизации

---

### Развитие автоматизации

[Badger](https://github.com/2gis/badger) - Cистема мониторинга качества продуктов

[vmmaster](https://github.com/2gis/vmmaster) - динамический selenium grid

Continuous integration - много Jenkins'ов с разными slave, Gitlab CI runners, Docker фермы

Нагрузочное тестирование

???
Про проект Badger можете посмотерь презентацию моей коллеги Ирины Шрейдер с SQADAYS http://sqadays.com/ru/talk/37798

Про проект Vmmaster можно посмотреть презентацию моего коллеги Коли Устинова с devday https://devday.ru/report/155

Continuous integration теперь это просто, развернул машинку, накатил ansible playbook, готово

Нагрузочное тестирование тоже получило свое, они разворачивают большие распределенные сеты с помощью heat в отдельных compute нода

---

template: inverse

## Нераскрытые темы

???
Так как тема обширная, подитожим и поймем что я не рассказал
---
### Нераскрытые темы

- OpenStack в production окружении

- Как мы деплоим OpenStack

- Как мы тестируем OpenStack в OpenStack'e

- Опыт разработки heat ресурсов

- Как мы закрываем *вот-такой то* сценарий

- А как жить с соседями, которые кошмарят compute ноды

???
Не рассказал я многое, например *список*

можете мне задать эти вопросы или любые другие сейчас или после доклада

---
name: last-page
template: inverse

## Спасибо!

Антон Галицын

[github.com/agalitsyn](http://github.com/agalitsyn)

name: inverse
layout: true
class: center, middle

---

# Автоматизация тестовой инфраструктуры

.footnote[Антон Галицын, [2GIS](2gis.ru)]

.right[![logo](images/codefest-logo.png)]

???

Всем привет, меня зовут Антон, и сегодня мы поговорим об автоматизации тестовой инфраструктуры в 2ГИСе

---

layout: false

## Зачем меня слушать?

- Разработчик в отделе Infrastrusture & Operations

- Работал в команде OpenStack

- Занимаюсь автоматизацией деплоймента проектов 2ГИСа

???

Я разработчик в отделе Infrastrusture & Operations, весь прошлый год целиком посвятил себя проекту OpenStack, разработкой систем деплоймента, утилит для тестирования как самого OpenStack, так и проектов web-отдела 2ГИС. Сейчас работаю над автоматизацией деплоймента рассчетных бекендов.

---

layout: false

## 2ГИС

- Web, Mobile, Desktop

- 35 команд

???

2ГИС - это городской справочник и карты. 2гис выпускается в разных версиях
* web
* мобильная (android, ios, windows phone)
* десктопная для windows

Все эти версии, а так же общие библиотеки и сервисы разрабатывает много команд, всего 35.

---

layout: false

## Команды

- Разные языки

- Много интеграций

???
Каждая команда, в зависимости от сферы, пишет на своем языке, использует какие-то инструменты. Можно представить себе этот зоопарк.

---

layout: false

## Команды

- Автоматическое тестирование

- Нужны достоверные результаты

???
Но есть то, что их объединяет - это интеграции. Поэтому каждая команда использует автоматическое тестирование и хочет получать достоверные результаты о своем продукте, и так же хочет того же от соседей.

---

template: inverse

## Достоверные автотесты

???

С автотестами я думаю у всех здесь возникали проблемы разного характера, я бы выделил одну из ключевых проблем - достоверность автотестов.

---

layout: false

## Достоверные автотесты

- Результат автотестов повторяем

- Результат соответсвует реальной картине на бою

???

Первое - Результаты автотестов должен быть повторяем. Если они то падают, то нет, доверия к тестам нет и их просто скипают или больше не пишут.

Второе - они реально отражают ситуацию на бою. Если в тестовой среде ничего не падает, а на бою падает, то в следующий раз тестировать будут прямо на бою. Зачем их гонять и ждать, они же все равно ничего не покажут.

---

layout: false

## Проблемы

- Большое количество конфигураций

- Неоднородные окружения

- Автотесты оставляют артефакты

???

Я бы выделил 3 ключевых проблемы, почему тесты могут быть не достоверны

Первая - большое количество конфигураций
Реальный кейс - надо прогнать определенные тесты для проверки фичи продукта A, собранного с ветки B и развернутого в конфигурации C.

Вторая - неоднородное окружение
У разработчика своя машина, он настраивает проект в vagrant, у тестировщика своя виртуальная машина на тестовых серверах. Все это скрипты, конфиги, где-то в этой цепочки есть баги, где-то ручные действия, иногда количество шагов достигает 10.

Вы скажете, а как же configuration management улитилы, типо ansible. Да, они есть, но не у всех они могут сдеплоить "не бой". А в 2гис сервисы большие, их много и разворачивать всегда копию боя невозможно.

Тесты портят и без того неоднородное окружение
Оставленные в кеше приложения тестовые данные, подвисшие процессы, измененная база - это все примеры артефактов после тестов. Приложение уже может выдавать другой результат при тех же тестах

---

layout: false

## Требования

- Список конфигураций проектов

- Автоматический деплоймент проектов

- Легко развертываемое окружение

- Автотесты не оставляют за собой мусор

???

Начали анализировать проблемы и пришли к следующим требованиям, которые помогут устранить проблемы

Нужны списки конфигураций для каждого проекта. Конфигурация "все над одной машине", конфигурация распределенная, конфигурация для нагрузочного тестирования и тд

Каждый проект должен уметь автоматический деплоиться во все нужные конфигурации общеизвестными способами. Ansible, chef

Окружение должно быть легко развертываемым, нельзя по полдня ждать виртуалок

Так же необходим рефакторинг автотестов, потому что после прогона они делают стенд неконсистентным

---

layout: false

## Требования

- Список конфигураций проектов

- Автоматический деплоймент проектов

- Легко развертываемое окружение

- ~~Автотесты не оставляют за собой мусор~~

???

Рефакторинг автотестов быстро отмели в сторону, тк их бывает по 60 000 на проект, и QA предпочитает концентрироваться на сценариях и параллельном исполнении тестов.

---

layout: false

## Требования

- Список конфигураций проектов &rarr; В команды

- Автоматический деплоймент проектов

- Легко развертываемое окружение

- ~~Автотесты не оставляют за собой мусор~~

???

Список конфигураций для проекта задача команды, они должны разобраться в зоопарке и выделить нескольк конфигураций, например all-in-one, окружение для автотестов, окружение для нагрузочного тестирования.

---

layout: false

## Требования

- Список конфигураций проектов &rarr; В команды

- Автоматический деплоймент проектов &rarr; В команды

- Легко развертываемое окружение

- ~~Автотесты не оставляют за собой мусор~~

???

Автоматический деплоймент конкретного проекта тоже задача команды, тк только они знают составные части своих продуктов.

---

layout: false

## Требования

- Список конфигураций проектов &rarr; В команды

- Автоматический деплоймент проектов &rarr; В команды

- Легко развертываемое окружение &rarr; Исследование

- ~~Автотесты не оставляют за собой мусор~~

???

Проблему легкого разворачивания мы легко побороть не смогли, тк она комплексная

---

template: inverse

## Исследование инфраструктурных проблем

???

Мы начали копать, изучая то, как сделана тестовая инфраструктура компании

---

template: inverse

## Инфраструктура не готова к новым требованиям

???

Мы пришли к выводу, что она абсолютна не готова нам помочь. Попробуем сформулировать проблемы.

---

layout: false

## Проблемы инфраструктуры

Конец 2013 года - Proxmox Virtual Environment

- Создание виртуалок по тикету руками

- Нет разделения по проектам

- API малофункционален, плагины платные

???

На конец 2013 года команды разработки и администрирования работали через тикеты, создать виртуалки, DNS, сеть, миграция - все руками.

Proxmox - это система система виртуализации с гипервизорами KVM и OpenVZ, которая может объедять узлы в одноранговый кластер. Управление через web GUI.

* Создание виртуалок по тикету
  Понятно - медленно, никто лишний раз обращаться не будет. У команд были либо уже созданные виртуалки, на которые сдеплоили 100500 раз. Деплоймент проекта на чистую машину часто не работает.

* Ничьи машинки
    Перестали пользоваться - ничего не сказали админам. В результате постоянно надо устраивать контрольные чистки с раздачей пинков.

Автоматизация была сильно ограничина в инструментах для инфраструктуры, по причине отсутвия нормального API и контроля доступа.

---

layout: false

## Что у нас есть?

&#10004; Свое железо

&#10004; Системные администраторы

&#10004; Использование виртуализации

???

Но не так уж все плохо, ведь стакан наполовину полон.

А полон он был железом, у 2гиса свои датацентры

Так же есть люди, которые умеют за ним следить

А так же администраторы умели как-то утилизировать железо виртуализацией.

---

layout: false

## Требования к решению

- Эффективная утилизация железа

- У команды свои ресурсы

- Модульность

- Легко дорабатывать под себя

- Программные интерфейсы

???

* Эффективная утилизация железа

Мы не хотели иметь заброшенные машины, и греть воздух в датацентре за счет конторы

- У команды свои ресурсы

Команда должна сама ухаживать за своим бытом

- Модульность

Собираем из компонентов

- Легко дорабатывать под себя

Это очень важно, чтобы не было vendor-lockin в наши непростые времена с санциями и ростом курса доллара

- Программные интерфейсы

Хочется использовать решение как платформу для построения более высокоуровневых решений

---

template: inverse

## OpenStack

???

Было проведено исследование мы выбрали OpenStack для интеграции в инфраструктуру компании

---

layout: false

## Что такое OpenStack?

OpenStack - набор сервисов с программными интерфейсами, которые позволяют управлять compute, storage и networking ресурсами в датацентре, а так же имеют общие сервисы.

???

И так, а что такое OpenStack?

OpenStack - набор сервисов с программными интерфейсами, которые позволяют управлять compute, storage и networking ресурсами в датацентре, а так же имеют общие сервисы.

OpenStack - конструктор для построения приватного или публичного облака. Это набор сервисов, каждый из которых имеет API и выполняет конкретную задачу, например создавать виртуальные машины, хранить образы, создавать DNS записи.

OpenStack сетапится на свое железо

---

layout: false

## OpenStack - open software

- Релиз раз в полгода [status.openstack.org](http://status.openstack.org)

- Базовые компоненты [github.com/openstack](https://github.com/openstack)

- Инкубатор [github.com/stackforge](https://github.com/stackforge)

- Конференции, встречи, Q&A, mail-lists [openstack.org/community](https://www.openstack.org/community/)

???

Релиз раз в полгода, что нас в полне устраивает. В релиз входят базовые компоненты. Каждый релиз включаются какие-то новые компоненты в ядро. Остальные компоненты подрастают в инкубатор некоторое время.

Нам важно понимать куда движется проект, тк это базовая вещь во многих вопросах. Roadmap публичный, куча движений в сообществе, нас это устраивает.

---

layout: false

## Контрибьюторы OpenStack

[openstack.org/foundation/companies](https://www.openstack.org/foundation/companies)

- Red Hat

- Rackspace

- IBM

- Intel

- HP

- Cisco

???

Это далеко не все контрибьюторы, но по списку видно, что эти ребята достаточно толсты.

---

layout: false

## Решение проблем инфраструктуры

&#10004; Эффективная утилизация железа

&#10004; У команды свои ресурсы

&#10004; Модульность

&#10004; Легко дорабатывать под себя

&#10004; Программные интерфейсы

???

С помощью компонентов этого продукта мы решили свои проблемы.

* Эффективная утилизация железа

Планировщик настраивается вплоть до программирования своей логики

* У команды свои ресурсы

Команда не может беспорядочно использовать ресурсы, теперь у них всегда убранно, иначе место просто кончится

* Модульность

Нужна новая фича - добавляем компонент или пишем свой

* Легко дорабатывать под себя

OpenStack написан на языке Python, что прекрасно, и мы может писать патчи, дополнять его и прочее

* Программные интерфейсы

Свои обвязки пишутся достаточно просто, тк все сервисы имеют API и ко всем сервисами есть python-биндинги. Надо просто брать библиотеки клиентов и писать код.

---

layout: false

## Легко развертываемое окружение

&#10004; Создаем распределенные стенды из шаблонов

&#10004; Проекты деплоятся на "чистые" стенды

&#10004; Все конфигурации проектов в коде

???

* Создаем распределенные стенды из шаблонов

Мы описываем ресурсы, их связи в шаблонах, шаблоны храним в гите, они доступны всем

* Проекты деплоятся на "чистые" стенды

Тк создать стенд это просто - все проекты всегда деплоятся с нуля

* Все конфигурации проектов в коде

У каждого проекта есть ansible / chef плейбуки с определенными конфигурациями

---

template: inverse

## Развитие автоматизации

---

layout: false

### badger

[github.com/2gis/badger](https://github.com/2gis/badger) - Cистема мониторинга качества продуктов

???

Cистема мониторинга качества продуктов.

Про проект Badger можете посмотерь презентацию моей коллеги Ирины Шрейдер с SQADAYS http://sqadays.com/ru/talk/37798

---

layout: false
background-image: url(images/badger.png)
count: false

---

### vmmaster

[github.com/2gis/vmmaster](https://github.com/2gis/vmmaster) - динамический selenium grid

???

Про проект Vmmaster можно посмотреть презентацию моего коллеги Коли Устинова с devday https://devday.ru/report/155

---

layout: false
background-image: url(images/vmmaster.png)
count: false

### vmmaster

---

layout: false
background-image: url(images/ci.png)
count: false

### Continuous integration

???

- Gitlab CI runners, Docker фермы

---

layout: false
background-image: url(images/load.png)
count: false

### Нагрузочное тестирование

---

template: inverse

## Это было начало

---

template: inverse

## Infrastrusture & Operations

???
Поэтому у нас есть отдел, готовый решить эти проблемы

---

layout: false

## Infrastrusture & Operations

- OpenStack

- Платформа для web и backend сервисов

- Автоматизацией HA баз данных

- Системой логирования и мониторинга

- Разработкой тулов для разработчиков

- Эксплуатацией боевой инфраструктуры

.footnote[.red[*] Мы используем python, ansible, docker, golang]

???

Мы занимаемся разными инфраструктурными проектами, такими как

- OpenStack

- Платформа для web и backend сервисов

- Автоматизация HA баз данных

- Система логирования и мониторинга

- Разработка тулов для разработчиков

- Эксплуатация боевой инфраструктуры

Юзаем python, ansible, docker, golang

---

template: inverse

## Нераскрытые темы

???
Так как тема обширная, подитожим и поймем что я не рассказал

---

layout: false

### Нераскрытые темы про OpenStack

- Эксплуатация

- Поддержка

- Деплой

- Апгрейд

- Тестирование

- Разработка плагинов

- Кастомизация

- Текущая инсталляция

???

Не рассказал я многое, например

- Эксплуатация

- Поддержка

- Деплой

- Апгрейд

- Тестирование

- Разработка плагинов

- Кастомизация

- Текущая инсталляция

можете мне задать эти вопросы или любые другие сейчас или после доклада

---

name: last-page
template: inverse

## Спасибо!

Антон Галицын

a.galitsyn@2gis.ru

[github.com/agalitsyn](http://github.com/agalitsyn)
